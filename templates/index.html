<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Alarma Comunitaria – Monitor</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <!-- ===========  ESTILOS  =========== -->
  <style>
    /* ---------- Layout general ---------- */
    body{
      font-family:Arial,Helvetica,sans-serif;
      margin:0; padding:0;
      background:#fafafa;
      display:flex; flex-direction:column;
      min-height:100vh;
    }

    /* ---------- Texto de estado ---------- */
    #estadoTexto{
      padding:20px; text-align:center;
      font-size:1.4rem;
      background:#333; color:#fff;
    }

    /* ---------- Stream de cámara ---------- */
    #videoCamara{
      display:none;                 /* se muestra cuando la cámara está operativa  */
      margin:20px auto;
      max-width:640px; width:100%;
    }
    #videoCamara img{
      width:100%;
      border-radius:8px;
      box-shadow:0 0 10px rgba(0,0,0,.3);
    }

    /* ---------- BARRA DE ALERTA FIJA ABAJO ---------- */
    #barraAlerta{
      position:fixed; left:0; right:0; bottom:0;
      background:#b00020; color:#fff;
      padding:14px 18px;
      font-weight:bold; font-size:1.05rem;
      cursor:pointer; user-select:none;
      box-shadow:0 -2px 8px rgba(0,0,0,.4);

      transition:max-height .3s ease, padding-bottom .3s ease;
      overflow:hidden;
      max-height:60px;      /* altura compacta */
      display:none;         /* se mostrará al recibir alerta */
    }
    #barraAlerta.expandida{
      max-height:280px;     /* espacio suficiente para texto + video */
      padding-bottom:18px;
    }
    #barraAlerta::after{
      content:'⬆'; float:right; margin-left:12px;
      font-size:1.3rem;
    }
    #barraAlerta.expandida::after{ content:'⬇'; }

    /* Contenedor flex para info + video  */
    #contenidoAlerta{
      margin-top:10px;
      display:none;
      flex-wrap:wrap; gap:15px;
    }
    #barraAlerta.expandida #contenidoAlerta{ display:flex; }

    /* Columna de texto */
    #infoAlerta{ flex:1 1 260px; font-size:.93rem; line-height:1.35; }

    /* Video grabado */
    #videoAlerta{
      flex:0 0 320px;             /* ancho fijo en desktop */
      max-width:100%;
      border-radius:8px;
    }
    @media (max-width:700px){     /* en móviles el video se apila debajo */
      #videoAlerta{ flex:1 1 100%; }
    }

    .etq{ font-weight:600; }
  </style>
</head>
<body>

  <!-- =======  Texto de estado  ======= -->
  <div id="estadoTexto">Determinando cámaras cercanas…</div>

  <!-- =======  Stream en vivo  ======= -->
  <div id="videoCamara">
    <img id="streamCamara" alt="Stream de cámara"/>
  </div>

  <!-- =======  Barra de alerta (compacta/expandida)  ======= -->
  <div id="barraAlerta">
    ⚠️ Alerta detectada — haz clic para ver/ocultar detalles
    <div id="contenidoAlerta">
      <!-- Columna texto -->
      <div id="infoAlerta">
        <p><span class="etq">Cámara:</span> <span id="txtCamara">-</span></p>
        <p><span class="etq">Alerta:</span> <span id="txtAlerta">-</span></p>
        <p><span class="etq">Mensaje:</span> <span id="txtMensaje">-</span></p>
        <p><span class="etq">Descripción:</span> <span id="txtDescripcion">-</span></p>
        <p><span class="etq">Fecha:</span> <span id="txtFecha">-</span></p>
        <p><span class="etq">Ubicación:</span> <span id="txtUbicacion">-</span></p>
      </div>

      <!-- Video -->
      <video id="videoAlerta" controls>
        <source id="srcVideoAlerta" src="" type="video/mp4">
      </video>
    </div>
  </div>

<!-- ===========  LÓGICA JAVASCRIPT  =========== -->
<script>
  /* ---------- Referencias DOM ---------- */
  const estadoTexto  = document.getElementById("estadoTexto");
  const videoCamara  = document.getElementById("videoCamara");
  const streamCamara = document.getElementById("streamCamara");

  const barraAlerta  = document.getElementById("barraAlerta");
  const txtCamara    = document.getElementById("txtCamara");
  const txtAlerta    = document.getElementById("txtAlerta");
  const txtMensaje   = document.getElementById("txtMensaje");
  const txtDescripcion = document.getElementById("txtDescripcion");
  const txtFecha     = document.getElementById("txtFecha");
  const txtUbicacion = document.getElementById("txtUbicacion");
  const srcVideoAlerta = document.getElementById("srcVideoAlerta");
  const videoAlerta  = document.getElementById("videoAlerta");

  let STREAM_URL = "";   // se llenará al primer uso

  /* ---------- Obtener URL pública del stream ---------- */
  async function obtenerUrlStream(){
    try{
      const r = await fetch("http://localhost:5000/get_ngrok_url");
      const j = await r.json();
      if(j.status==="success"){ STREAM_URL=j.ngrok_url; return true; }
      throw new Error(j.message||"Sin éxito");
    }catch(e){
      console.error("URL stream:",e.message);
      return false;
    }
  }

  /* ---------- Socket.IO ---------- */
  const socket = io();  // mismo host

  socket.on("connect",()=>{
    navigator.geolocation.getCurrentPosition(
      pos=>socket.emit("registrar",{lat:pos.coords.latitude,lon:pos.coords.longitude}),
      ()=>socket.emit("registrar",{lat:-0.0626,lon:-78.4516})
    );
  });

  /* ---- Evento con status (y posible detalle) ---- */
  socket.on("evento", async data=>{
    if(!data) return;

    /* STATUS */
    if(data.status){
      if(data.status.includes("Camara operativa")){
        estadoTexto.textContent = "Cámara activa operativa";
        if(!STREAM_URL){
          const ok = await obtenerUrlStream();
          if(ok){
            streamCamara.src = STREAM_URL;
            videoCamara.style.display = "block";
          }
        }else{
          videoCamara.style.display = "block";
        }
      }else{
        estadoTexto.textContent = data.status;
        videoCamara.style.display = "none";
      }
    }

    /* DETALLE DE ALERTA */
    if(data.detalle) mostrarAlerta(data.detalle);
  });

  /* ---- Evento con detalle actualizado ---- */
  socket.on("actualizar_camara", data=>{
    if(data) mostrarAlerta(data);
  });

  /* ---------- Mostrar / rellenar barra de alerta ---------- */
  function mostrarAlerta(det){
    if(!det.alerta || det.alerta==="Todo en orden") return;

    txtCamara.textContent  = det.nombre_camara || "-";
    txtAlerta.textContent  = det.alerta;
    txtMensaje.textContent = det.informacion_extra?.mensaje || "-";
    txtDescripcion.textContent = det.informacion_extra?.Descripcion || "-";
    txtFecha.textContent   = new Date(det.fecha).toLocaleString();
    txtUbicacion.textContent = det.ubicacion
      ? `${det.ubicacion.lat.toFixed(4)}, ${det.ubicacion.lon.toFixed(4)}`
      : "-";

    if(det.informacion_extra?.url_video){
      srcVideoAlerta.src = det.informacion_extra.url_video;
      videoAlerta.load();
      videoAlerta.style.display="block";
    }else{
      srcVideoAlerta.src="";
      videoAlerta.load();
      videoAlerta.style.display="none";
    }

    barraAlerta.style.display="block";
    barraAlerta.classList.remove("expandida");  // inicia compacta
  }

  /* Expandir / colapsar */
  barraAlerta.addEventListener("click",()=>{
    barraAlerta.classList.toggle("expandida");
  });
</script>
</body>
</html>
